<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Marketing Template Editor</title>

  <!-- App CSS -->
  <link rel="stylesheet" href="/static/css/marketing-template.css">

  <!-- libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<h1>Marketing Template Editor</h1>

<div class="controls">
  <!-- Background color and logo upload controls removed per latest requirements -->

  <!-- Combined color control removed per request -->

  <div style="margin-top:8px;">
    <label for="stateFilter">Select State:</label>
    <select id="stateFilter">
      <option value="">-- All States --</option>
      <option value="Maharashtra">Maharashtra</option>
      <option value="Tamil Nadu">Tamil Nadu</option>
      <option value="Gujarat">Gujarat</option>
      <option value="Karnataka">Karnataka</option>
      <option value="Telangana">Telangana</option>
      <option value="West Bengal">West Bengal</option>
      <option value="Andhra Pradesh">Andhra Pradesh</option>
      <option value="Rajasthan">Rajasthan</option>
      <option value="Uttar Pradesh">Uttar Pradesh</option>
      <option value="Madhya Pradesh">Madhya Pradesh</option>
      <option value="Delhi">Delhi</option>
      <option value="Punjab">Punjab</option>
      <option value="Haryana">Haryana</option>
      <option value="Bihar">Bihar</option>
      <option value="Odisha">Odisha</option>
      <option value="Kerala">Kerala</option>
      <option value="Assam">Assam</option>
      <option value="Jharkhand">Jharkhand</option>
      <option value="Chhattisgarh">Chhattisgarh</option>
      <option value="Uttarakhand">Uttarakhand</option>
      <option value="Goa">Goa</option>
      <option value="Himachal Pradesh">Himachal Pradesh</option>
      <option value="Jammu and Kashmir">Jammu and Kashmir</option>
      <option value="Puducherry">Puducherry</option>
      <option value="Chandigarh">Chandigarh</option>
      <option value="Chandigarh">Chandigarh</option>
    </select>

    <label style="margin-left:10px;">Select Language:</label>
    <select id="languageSelect">
      <option value="en" selected>English</option>
      <option value="hi">Hindi</option>
      <option value="gu">Gujarati</option>
      <option value="mr">Marathi</option>
      <option value="ta">Tamil</option>
      <option value="te">Telugu</option>
      <option value="bn">Bengali</option>
      <option value="kn">Kannada</option>
    </select>

    <span id="langColumnStatus" style="margin-left:10px; font-size:11px; color:#999;"></span>

    <button id="generateStateTemplates" style="margin-left:10px;">Generate Templates</button>
    <button onclick="clearAllTemplates()" style="margin-left:10px; background:#dc3545; color:white;">üóëÔ∏è Clear Templates</button>
  </div>

  <div style="margin-top:10px;"> 
    <label>Upload Stores Excel (.xlsx/.xls/.csv):</label>
    <input type="file" id="storesExcel" accept=".xlsx,.xls,.csv">
  </div>

  <div style="margin-top:8px;">
    <label>Footer Text & Logo Color:</label>
    <input type="color" id="footerTextColor" value="#9A6C0C">
    <button type="button" onclick="applyFooterColor()">Apply Footer Color</button>
  </div>

  <div style="margin-top:8px;">
    <label>Add Footer Text:</label>
    <input type="text" id="footerName" placeholder="Store Name">
    <label style="margin-left:8px;">WhatsApp Number:</label>
    <input type="text" id="footerWhatsApp" placeholder="WhatsApp Number">
    <button type="button" onclick="updateFooterInfo()">Update Footer Text & WhatsApp</button>
  </div>
<div style="margin-top:8px;">
    <button onclick="downloadAllPerfectA4()" style="background:#555; color:white; font-weight:bold;">üñ® Download Perfect A4 PDF</button>
  </div>


  <div style="margin-top:10px;">
    <label>Upload Custom Template:</label>
    <input type="file" id="templateUpload" accept="image/*">
  </div>





  <div style="margin-top:10px;">
    <label>Upload Primary Template (English):</label>
    <input type="file" id="templateUploadPrimary" accept="image/*">
  </div>
  <div id="primaryTemplateBox" style="margin:10px 0; min-height:120px; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; background:#fafafa;"></div>

  <!-- Upload secondary (local-language) template -->
  <div style="margin-top:10px;">
    <label>Upload Secondary Template (Local language):</label>
    <input type="file" id="templateUploadSecondary" accept="image/*">
    <small style="display:block;color:#666;">Secondary template uses address_hi, address_mr, etc.</small>
  </div>
  <div id="secondaryTemplateBox" style="margin:10px 0; min-height:120px; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; background:#fafafa;"></div>

</div> <!-- end controls -->
</div>


<!-- single main editable template -->
<div id="templateBox" class="template-box lang-en">
  <div id="storeFooterName">Default Store Name</div>
  <div id="storeFooter"></div>
</div>

<!-- <div id="primaryTemplateBox" style="margin:10px 0; min-height:120px; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; background:#fafafa;"></div>
<div id="secondaryTemplateBox" style="margin:10px 0; min-height:120px; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; background:#fafafa;"></div>

 -->



<div style="margin-top:20px;">
  <button onclick="downloadTemplateWithLang('primary')">Download Primary</button>
  <button onclick="downloadTemplateWithLang('secondary')">Download Secondary</button>
</div>





<div id="templatesContainer" style="margin-top:20px; width:100%; max-width:1200px;"></div>

<h2 style="width:100%; max-width:1200px; margin-left: calc(50% - 600px);">Templates</h2>
<div class="thumbnail-slider" id="templateSlider" style="width:100%; max-width:1200px;"></div>

<h2 style="width:100%; max-width:1200px; margin-left: calc(50% - 600px);">Products</h2>
<div class="thumbnail-slider" id="productSlider" style="width:100%; max-width:1200px;"></div>

<h2 style="width:100%; max-width:1200px; margin-left: calc(50% - 600px);">Banners</h2>
<div class="thumbnail-slider" id="bannerSlider" style="width:100%; max-width:1200px;"></div>
<script src="/static/js/marketing-template.js"></script>


<script>

  // your old JS code here
  // your preview rendering code here

  /* ---- PASTE HERE ---- */

  async function downloadTemplateWithLang(kind = 'primary') {
    const templateBox = document.getElementById('templateBox');
    const footerPrimary = document.getElementById('storeFooterName');
    const footerLegacy = document.getElementById('storeFooter');

    const englishAddress = "21B, Annamalai Nagar, Karur Bypass Road, Tiruchirappalli | 9156121076";
    const localAddress   = "168A, ‡Æï‡Æø‡Æ¥‡Æµ‡ØÜ‡Æ≤‡Æø ‡Æµ‡ØÄ‡Æ§‡Æø, ‡ÆÆ‡Æ§‡ØÅ‡Æ∞‡Øà | 9156121076";

    const footerValue = (kind === 'primary') ? englishAddress : localAddress;
    const parts = footerValue.split('|');
    const addressPart = (parts[0] || "").trim();
    const phonePart = (parts[1] || "").trim();
    const footerHtml = `<span class="store-address">${escapeHtml(addressPart)}</span>${buildContactSegment(phonePart)}`;

    [footerPrimary, footerLegacy].forEach(el => {
      if (!el) return;
      el.innerHTML = footerHtml;
      el.style.display = "inline-flex";
      el.style.alignItems = "center";
      el.style.justifyContent = "center";
      el.style.whiteSpace = "nowrap";
      el.style.pointerEvents = "none";
      el.setAttribute('lang', kind === 'primary' ? 'en' : 'ta');
      el.style.fontFamily = kind === 'primary'
        ? "'Noto Sans', 'Arial', sans-serif"
        : "'Noto Sans Tamil', 'Noto Sans', sans-serif";
    });

    syncFinalLayerFor(templateBox);
    await inlineSvgAsDataUrl('#storeFooterName .contact-icon img');
    await inlineSvgAsDataUrl('#storeFooterNameFinal .contact-icon img');
    await inlineSvgAsDataUrl('#storeFooter .contact-icon img');
    runFooterFixes(templateBox);

    if (document.fonts && document.fonts.ready) await document.fonts.ready;
    await waitForImagesInNode(templateBox, 3000);

    void templateBox.offsetHeight;
    await new Promise(r => setTimeout(r, 150));

    const canvas = await html2canvas(templateBox, {
      scale: 2,
      useCORS: true,
      allowTaint: false,
      scrollY: -window.scrollY
    });

    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: 'pt', format: 'a4' });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const imgWidth = pageWidth;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    const filename = (kind === 'primary') ? 'template_primary_english.pdf' : 'template_secondary_local.pdf';
    pdf.save(filename);
  }

  function waitForImagesInNode(node, timeout = 3000) {
    const imgs = Array.from(node.querySelectorAll('img'));
    if (!imgs.length) return Promise.resolve();
    return new Promise(resolve => {
      let remaining = imgs.length;
      const done = () => { if (--remaining <= 0) resolve(); };
      imgs.forEach(img => {
        if (img.complete) done();
        else { img.addEventListener('load', done); img.addEventListener('error', done); }
      });
      setTimeout(resolve, timeout);
    });
  }

  /* ---- END PASTE ---- */

</script>

</body>
</html>
